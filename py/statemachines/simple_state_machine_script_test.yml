--- # Test State Machine
name: SM_TOP
template: StateMachineBase
node_name: test_simple_action_state_machine
states:
  - RECONFIGURE_HEXAPOD:
      template: StateMachine
      states:
      - READ_HEXAPOD_CURRENT_POSE:
          template: ReadTransformState
          target_frame: ur10_1/base
          source_frame: hexapod_1/top
          transform_output: hexapod_current_pose
          succeeded: MOVE_ABOVE_HEXAPOD_1
      
      - MOVE_ABOVE_HEXAPOD_1:
          template: CartTrapVelActionState
          robot: ur10_1
          pose_input: hexapod_current_pose
          position_offset: [0.0, 0.0, -0.20]
          rotation_offset: [0.0, 0.0, 0.0, 0.0]
          desired_velocity: 0.1
          succeeded: OPEN_TOOL_EXCHANGE_1
      
      - OPEN_TOOL_EXCHANGE_1:
          template: SetOutputState
          robot: ur10_1
          output_number: TOOL_EXCHANGE_GPIO
          value: TOOL_EXCHANGE_OPEN
          succeeded: COUPLE_WITH_HEXAPOD 

      - COUPLE_WITH_HEXAPOD:
          template: CartLinTaskActionState
          robot: ur10_1
          position: [0.0, 0.0, 0.0]
          rotation: [0.0, 0.0, 0.0, 0.0]
          desired_travel_time: 3
          succeeded: CLOSE_TOOL_EXCHANGE_1
      
      - CLOSE_TOOL_EXCHANGE_1:
          template: SetOutputState
          robot: ur10_1
          output_number: TOOL_EXCHANGE_GPIO
          value: TOOL_EXCHANGE_CLOSE
          succeeded: RELEASE_HEXAPOD_BRAKES 
      
      - RELEASE_HEXAPOD_BRAKES:
          template: SetOutputState
          robot: ur10_1
          output_number: HEXAPOD_BRAKE_1_GPIO
          value: HEXAPOD_BRAKE_OPEN
          succeeded: READ_HEXAPOD_MIDDLE_POSE

      - READ_HEXAPOD_MIDDLE_POSE:
          template: ReadTransformState
          target_frame: ur10_1/base
          source_frame: hexapod_1/mid
          transform_output: hexapod_middle_pose
          succeeded: SECONDARY_META_STATE

      succeeded: SECONDARY_META_STATE
  
  - SECONDARY_META_STATE:
      template: StateMachine
      states:
      - SUB_STATE_1:
          template: ReadTransformState
          target_frame: ur10_2/base
          source_frame: hexapod_1/top
          transform_output: hexapod_current_pose
          succeeded: SUB_STATE_2
      
      - SUB_STATE_2:
          template: ReadTransformState
          target_frame: ur10_2/base
          source_frame: hexapod_1/top
          transform_output: hexapod_current_pose
          succeeded: TERNARY_META_STATE

      - TERNARY_META_STATE:
          template: StateMachine
          states:
          - SUB_SUB_STATE_1:
              template: ReadTransformState
              target_frame: ur10_2/base
              source_frame: hexapod_1/top
              transform_output: hexapod_current_pose
              succeeded: FOURTH_META_STATE

          - FOURTH_META_STATE:
              template: StateMachine
              states:
              - SUB_SUB_SUB_STATE_1:
                  template: ReadTransformState
                  target_frame: ur10_2/base
                  source_frame: hexapod_1/top
                  transform_output: hexapod_current_pose
                  succeeded: succeeded

              succeeded: succeeded

          succeeded: succeeded
  
      succeeded: succeeded

succeeded: succeeded
